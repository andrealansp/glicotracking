version: "3.9"

services:
  glicoctk_bd:
    image: postgres:15
    restart: always
    environment:
        POSTGRES_DB: ${DB_NAME}
        POSTGRES_USER: ${DB_USER}
        POSTGRES_PASSWORD: ${DB_HOST}
    ports:
        - "5434:5432"
    networks:
      - alvesdevpynet

    volumes:
      - pgdata:/var/lib/postgresql/data

  glicotck:
    image: glicotracking-glicotracking:latest
    command: gunicorn app.wsgi:application --bind 0.0.0.0:8000
    environment:
      - DJANGO_SETTINGS_MODULE=app.settings
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - glico_data:/glicotracking
      - static_volume:/glicotracking/static
      - media_volume:/glicotracking/media
    networks:
      - alvesdevpynet

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      labels:
        - traefik.enable=true
        - traefik.http.routers.glicotck.rule=Host(`glicotracking.alvesdevpy.com.br`)
        - traefik.http.routers.glicotck.entrypoints=websecure
        - traefik.http.routers.glicotck.priority=1
        - traefik.http.routers.glicotck.tls.certresolver=letsencryptresolver
        - traefik.http.routers.glicotck.service=glicotck
        - traefik.http.services.glicotck.loadbalancer.server.port=8000
        - traefik.http.services.glicotck.loadbalancer.passHostHeader=1

volumes:
  glico_data:
  static_volume:
  media_volume:
  pgdata:

networks:
  alvesdevpynet:
     external: true  # ‚Üê IMPORTANTE: Usa rede existente
     driver: overlay