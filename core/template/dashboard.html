{% extends "base.html" %}
{% block dashboard %}
<!-- Carregue Chart.js PRIMEIRO -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Depois o ChartDataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

{% endblock %}
{% block content %}


<!--Faixa inicial do dashboard-->
<div class="row m-3">
    <div class="col-3">
        <div class="card ">
            <div class="card-body bg">
                <h4>Última Medição</h4>
                <span>{{ultima_medicao}}</span>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card ">
            <div class="card-body bg">
                <h4>Tempo no Alvo</h4>
                {{tir_percent}} %
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card ">
            <div class="card-body bg">
                <h4>Glicada Estimada</h4>
                <span>{{glicada_estimada|floatformat:2 }} %</span>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card ">
            <div class="card-body bg">
                <h4>Peso Desejado</h4>
                <span>{{peso_ideal}} Kg</span>
            </div>
        </div>
    </div>
</div>


<!-- Gráfico de Glicose -->
<div class="row justify-content-around m-3">
    <div class="col-12 overflow-auto">
        <div class="card ">
            <div class="card-body bg ">
                <canvas id="glicoseChart" ></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-around m-3">
    <div class="col-6 ">
        <div class="card">
            <div class="card-body bg">
                <canvas id="graficoPesoImc"></canvas>
            </div>
        </div>
    </div>
    <div class="col-6">
        <div class="card">
            <div class="card-body bg">
                <canvas id="graficoBiotipo"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    const legenda = JSON.parse('{{ dados_grafico.legendas|safe }}');
    const dados = JSON.parse('{{ dados_grafico.dados|safe }}');
    const tipo = JSON.parse('{{ dados_grafico.tipo|safe }}');
    const historicoPesoImcData = JSON.parse('{{ historico_peso_imc|escapejs }}');
    const historicoBiotipoData = JSON.parse('{{ historico_biotipo|escapejs }}');

    <!-- Gráfico de Glicose    -->
    // 1. Definimos o Plugin customizado para as linhas horizontais
const horizontalLinesPlugin = {
    id: 'horizontalLines',
    afterDatasetsDraw(chart, args, options) {
        const { ctx, scales: { x, y } } = chart;

        // Função auxiliar para desenhar a linha
        function drawLine(value, color, text) {
            // Verifica se o valor está dentro da área visível do gráfico
            if (value < y.min || value > y.max) return;

            const yPos = y.getPixelForValue(value);

            ctx.save();
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = color;
            // Cria um efeito tracejado (opcional, fica mais elegante)
            ctx.setLineDash([5, 5]);
            ctx.moveTo(x.left, yPos);
            ctx.lineTo(x.right, yPos);
            ctx.stroke();

            if (text) {
                ctx.fillStyle = color;
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(text, x.right - 10, yPos - 10);
            }
            ctx.restore();
        }

        // Desenhando as linhas
        drawLine(180, 'rgba(220, 53, 69, 0.5)', 'Muito Alta');      // Vermelho
        drawLine(160, 'rgba(253, 126, 20, 0.5)', 'Alta');            // Laranja
        drawLine(100, 'rgba(32, 201, 151, 0.5)', 'Normal Jejum');    // Verde Água
        drawLine(70,  'rgba(0, 123, 255, 0.5)', 'Hipoglicemia');     // Azul
    }
};

// 2. Configuração do Gráfico
const ctxGlicose = document.getElementById('glicoseChart').getContext('2d');

new Chart(ctxGlicose, {
    type: 'line',
    data: {
        labels: legenda, // Suas variáveis
        datasets: [{
            label: 'Glicose (Últimos 30 dias)',
            data: dados, // Suas variáveis
            borderColor: 'rgb(127, 255, 0)',
            backgroundColor: 'rgb(127, 255, 0)', // Necessário para o datalabels usar a cor
            tension: 0.3,
            pointRadius: 4, // Tamanho da bolinha
        }]
    },
    // 3. REGISTRO DOS PLUGINS (Aqui é a mudança principal)
    plugins: [ChartDataLabels, horizontalLinesPlugin],
    options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 3,
        scales: {
            y: {
                // Sugestão: Definir um min/max sugerido para as linhas sempre aparecerem
                suggestedMin: 50,
                suggestedMax: 200
            }
        },
        plugins: {
            // Configuração do Plugin DataLabels
            datalabels: {
                align: 'end',
                anchor: 'end',
                backgroundColor: function(context) {
                    return context.dataset.borderColor;
                },
                borderRadius: 4,
                color: 'black',
                font: {
                    weight: 'bold',
                    size: 11
                },
                padding: 4,
                offset: 4,
                formatter: function(value) {
                    return Math.round(value); // Arredonda o valor
                }
            },
            title: {
                display: true,
                text: 'Monitoramento de Glicose',
                font: { size: 16 }
            },
            legend: {
                display: true // Mostra a legenda do dataset
            }
        }
    }
});

    <!-- Gráfico de barras agrupadas com peso e IMC -->
    const ctxPesoImc = document.getElementById('graficoPesoImc').getContext('2d');
    const graficoPesoImc = new Chart(ctxPesoImc, {
        type: 'bar',
        data: {
            labels: historicoPesoImcData.map(item => new Date(item.data_registro).toLocaleDateString()),
            datasets: [{
                label: 'Peso (kg)',
                data: historicoPesoImcData.map(item => parseFloat(item.peso_kg)),
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                yAxisID: 'y-peso'
            }, {
                label: 'IMC',
                data: historicoPesoImcData.map(item => parseFloat(item.imc)),
                backgroundColor: 'rgba(255, 206, 86, 0.8)',
                borderColor: 'rgba(255, 206, 86, 1)',
                borderWidth: 1,
                datalabels: {
                    formatter: function (value, context) {
                        return value + " Kg/m2";
                    }
                },
                yAxisID: 'y-imc'
            }]
        },
        options: {
            scales: {
                'y-peso': {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Peso (kg)'
                    }
                },
                'y-imc': {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'IMC'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Data'
                    }
                }
            },
            plugins: {
                datalabels: {
                    align: 'end',
                    anchor: 'end',
                    backgroundColor: function (context) {
                        return context.dataset.borderColor;
                    },
                    borderRadius: 10,
                    borderWidth: 2,
                    color: 'white',
                    font: {
                        weight: 'bold'
                    },
                    formatter: function (value, context) {
                        return value + ' kg';
                    },
                    padding: 6,
                    offset: 8
                },
                title: {
                    display: true,
                    text: 'Peso e IMC'
                }
            },

        }
    });

    // --- Gráfico de Biotipo ---
    const ctxBiotipo = document.getElementById('graficoBiotipo').getContext('2d');
    const graficBiotipo = new Chart(ctxBiotipo, {
        type: 'bar',  // ← Mudou de 'line' para 'bar'
        data: {
            labels: historicoBiotipoData.map(item => new Date(item.data_registro).toLocaleDateString()),
            grouped: true,
            datasets: [{
                label: 'Cintura',
                data: historicoBiotipoData.map(item => parseFloat(item.cintura)),
                backgroundColor: 'rgb(49, 103, 237)',
                borderColor: 'rgb(49, 103, 237)',
                borderWidth: 1,
                barThickness: 30,
                datalabels: {
                    backgroundColor: 'rgb(49, 103, 237)',
                    align: "end",
                    padding: 6,
                    textAlign: "center",
                    anchor: "end",
                    formatter: function (value) {
                        return value;
                    },
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 10
                    }
                }
            }, {
                label: 'Quadril',
                data: historicoBiotipoData.map(item => parseFloat(item.quadril)),
                backgroundColor: 'rgba(50, 182, 41, 0.9)',
                borderColor: 'rgba(50, 182, 41, 1)',
                borderWidth: 1,
                barThickness: 30,
                datalabels: {
                    backgroundColor: 'rgba(50, 182, 41, 1)',
                    align: "end",
                    padding: 6,
                    textAlign: "center",
                    anchor: "end",
                    formatter: function (value) {
                        return value;
                    },
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 10
                    }
                }
            }, {
                label: 'Braços',
                data: historicoBiotipoData.map(item => parseFloat(item.braço)),
                backgroundColor: 'rgba(255, 159, 64, 0.9)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                barThickness: 30,
                datalabels: {
                    backgroundColor: 'rgba(255, 159, 64, 1)',
                    align: "end",
                    padding: 6,
                    textAlign: "center",
                    anchor: "end",
                    formatter: function (value) {
                        return value;
                    },
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 10
                    }
                }
            }, {
                label: 'Perna',
                data: historicoBiotipoData.map(item => parseFloat(item.perna)),
                backgroundColor: 'rgba(153, 102, 255, 0.9)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1,
                barThickness: 30,
                datalabels: {
                    backgroundColor: 'rgba(153, 102, 255, 1)',
                    align: "end",
                    padding: 6,
                    textAlign: "center",
                    anchor: "end",
                    formatter: function (value) {
                        return value;
                    },
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 10
                    }
                }
            }, {
                label: 'Abdômen',
                data: historicoBiotipoData.map(item => parseFloat(item.abdomen)),
                backgroundColor: 'rgba(255, 99, 132, 0.9)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                barThickness: 30,
                datalabels: {
                    backgroundColor: 'rgba(255, 99, 132, 1)',
                    align: "end",
                    padding: 6,
                    textAlign: "center",
                    anchor: "end",
                    formatter: function (value) {
                        return value;
                    },
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 10
                    }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    min: 0,
                    max: 190,
                    title: {
                        display: true,
                        text: 'Circunferência (CM)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Data'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Biotipo'
                }
            }
        }
    });
</script>
{% endblock %}